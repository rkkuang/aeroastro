import astropy.io.fits as fits
import numpy as np
import os

def mpl9_DRP():
    '''
    Of the 8405 data cubes, 8113 represent galaxies (i.e., discounting the Coma, IC342, and M31 plates, and a few other non-galaxy special plates)
    Of these 8113 galaxy data cubes, there are 8000 unique galaxies as determined by their mangaid identifiers.

    nohup python3 download_data.py > nohup.txt 2>&1 &
    '''
    file_drpall = 'drpall-v2_7_1.fits'
    drpall = fits.getdata(file_drpall, ext=1)
    tmp = ((drpall['mngtarg1'] != 0) | (drpall['mngtarg3'] != 0)) & ((drpall['mngtarg3'] & (2**19 + 2**20 + 2**21) == 0)
    galaxies = drpall[tmp]
    plateifu = galaxies['plateifu']
    plateifu = np.sort(plateifu)

    with open('MPL8_list.txt', 'w') as tmp:
        for gal in plateifu:
            tmp.write(gal + '\n')

    for i, gal in enumerate(plateifu):
        tmp = gal.split('-')
        plate = tmp[0]
        ifu = tmp[1]
        os.makedirs('MPL9-LOGCUBE/' + plate, exist_ok=True)
        tmpfile = 'manga-' + gal + '-LOGCUBE.fits.gz'
        tmp = 'wget --user=sdss --password=2.5-meter https://data.sdss.org/sas/mangawork/manga/spectro/redux' + \
              '/MPL-9/' + plate + '/stack/' + tmpfile + ' -O MPL9-LOGCUBE/' + plate + '/' + tmpfile
        os.system(tmp)

        os.makedirs('MPL9-image/' + plate, exist_ok=True)
        tmp = 'wget --user=sdss --password=2.5-meter https://data.sdss.org/sas/mangawork/manga/spectro/redux' + \
              '/MPL-9/' + plate + '/images/' + ifu + '.png -O MPL9-image/' + plate + '/' + gal + '.png'
        os.system(tmp)

        tmp = 'wget --user=sdss --password=2.5-meter https://data.sdss.org/sas/mangawork/manga/spectro/redux' + \
              '/MPL-9/' + plate + '/images/' + ifu + '_thumb.png -O MPL9-image/' + plate + '/' + gal + \
              '_thumb.png'
        os.system(tmp)

        os.makedirs('MPL9-LINCUBE/' + plate, exist_ok=True)
        tmpfile = 'manga-' + gal + '-LINCUBE.fits.gz'
        tmp = 'wget --user=sdss --password=2.5-meter https://data.sdss.org/sas/mangawork/manga/spectro/redux' + \
              '/MPL-9/' + plate + '/stack/' + tmpfile + ' -O MPL9-LINCUBE/' + plate + '/' + tmpfile
        os.system(tmp)

mpl9_DRP()
